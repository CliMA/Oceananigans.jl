env:
  JULIA_VERSION: "1.8.5"
  JULIA_MINOR_VERSION: "1.8"
  SVERDRUP_HOME: "/data5/glwagner"
  TARTARUS_HOME: "/storage5/buildkite-agent"
  GKSwstype: "100" # See: https://github.com/jheinen/GR.jl/issues/278

steps:

#####
##### Setup 
#####

  - label: "gpu ğŸª setup"
    key: "init_gpu"
    env:
      TEST_GROUP: "none"
    plugins:
      - JuliaCI/julia#v1:
          version: "1.8"
      - JuliaCI/julia-test#v1:
          coverage: false
    agents:
      queue: Oceananigans
      architecture: GPU

  - label: "cpu ğŸ•ï¸ setup"
    key: "init_cpu"
    env:
      TEST_GROUP: "none"
      CUDA_VISIBLE_DEVICES: "-1"
    plugins:
      - JuliaCI/julia#v1:
          version: "1.8"
      - JuliaCI/julia-test#v1:
          coverage: true
    agents:
      queue: Oceananigans
      architecture: CPU

#####
##### Tests
#####

  - label: "gpu {{matrix.group}}"
    matrix:
      setup:
        group:
          - "ğŸ¿ï¸ unit"
          - "ğŸ¦… poisson_solvers_1"
          - "ğŸ¦– poisson_solvers_2"
          - "ğŸŒ· matrix_poisson_solvers"
          - "ğŸ¦¤ general_solvers"
          - "ğŸ¦€ time_stepping_1"
          - "ğŸ¦ˆ time_stepping_2"
          - "ğŸ¦Ÿ time_stepping_3"
          - "ğŸ£ turbulence_closures"
          - "ğŸ™ hydrostatic_free_surface"
          - "ğŸ¦¢ shallow_water"
          - "ğŸ³ simulation"
          - "ğŸ‚ lagrangian"
          - "ğŸ‘» abstract_operations"
          - "ğŸ¡ cubed_sphere"
          - "ğŸ§… multi_region"
          - "ğŸ‰ nonhydrostatic_regression"
          - "ğŸ« hydrostatic_regression"
          - "ğŸ™ˆ scripts"
    env:
      TEST_GROUP: "{{matrix.group}}"
    plugins:
      - JuliaCI/julia#v1:
          version: "1.8"
      - JuliaCI/julia-test#v1:
          update_registry: false
          coverage: false
    agents:
      queue: Oceananigans
      architecture: GPU
    depends_on: "init_gpu"
    if: !build.pull_request.draft

  - label: "cpu {{matrix.group}}"
    matrix:
      setup:
        group:
          - "ğŸ‡ unit"
          - "ğŸ•Šï¸ poisson_solvers_1"
          - "ğŸ¦• poisson_solvers_2"
          - "ğŸŒ¹ matrix_poisson_solvers"
          - "ğŸ¦ƒ general_solvers"
          - "ğŸ¦ time_stepping_1"
          - "ğŸ¬ time_stepping_2"
          - "ğŸ¦— time_stepping_3"
          - "ğŸ turbulence_closures"
          - "ğŸ¦‘ hydrostatic_free_surface"
          - "ğŸ¦† shallow_water"
          - "ğŸ‹ simulation"
          - "ğŸƒ lagrangian"
          - "ğŸ¤– abstract_operations"
          - "ğŸ¦” cubed_sphere"
          - "ğŸ§„ multi_region"
          - "ğŸ¦¾ nonhydrostatic_regression"
          - "ğŸª hydrostatic_regression"
          - "ğŸ™‰ scripts"

    env:
      TEST_GROUP: "{{matrix.group}}"
      CUDA_VISIBLE_DEVICES: "-1"
    plugins:
      - JuliaCI/julia#v1:
          version: "1.8"
      - JuliaCI/julia-test#v1:
          update_registry: false
          coverage: false
    agents:
      queue: Oceananigans
      architecture: CPU
    depends_on: "init_cpu"
    if: !build.pull_request.draft

#####
##### Distributed/MPI
#####

  - label: "cpu ğŸ‰ distributed {{matrix.group}} tests"
    matrix:
      setup:
        group:
          - "distributed"
          - "distributed_solvers"
    env:
      TEST_GROUP: "{{matrix.group}}"
      CUDA_VISIBLE_DEVICES: "-1"
    plugins:
      - JuliaCI/julia#v1:
          version: "1.8"
    command: |
      julia -O0 --color=yes --project -e 'using MPI; MPI.install_mpiexecjl(;destdir=".")'
      ./mpiexecjl -np 4 julia -O0 --color=yes --project -e 'using Pkg; Pkg.test()'
    agents:
      queue: Oceananigans
      architecture: CPU
    depends_on: "init_cpu"
    if: !build.pull_request.draft


  # We get a SegFault. We probably need more devices to run this test
  # - label: "gpu ğŸ² distributed unit tests"
  # env:
  #   JULIA_DEPOT_PATH: "$SVERDRUP_HOME/.julia-$BUILDKITE_BUILD_NUMBER"
  #   TEST_GROUP: "distributed"
  #   CUDA_VISIBLE_DEVICES: "0"
  #   PATH: "$PATH:$SVERDRUP_HOME/julia-$JULIA_VERSION/bin" # Need julia binary in $PATH for mpiexecjl to work.
  #   JULIA_BINDIR: "$SVERDRUP_HOME/julia-$JULIA_VERSION/bin"
  # commands:
  #   - "$SVERDRUP_HOME/.julia-$BUILDKITE_BUILD_NUMBER/bin/mpiexecjl -np 4 $SVERDRUP_HOME/julia-$JULIA_VERSION/bin/julia -O0 --color=yes --project -e 'using Pkg; Pkg.test()'"
  # agents:
  #   queue: Oceananigans
  #   architecture: GPU
  # depends_on: "init_gpu"


#####
##### Documentation
#####

  - label: "ğŸ¦‰ documentation"
    env:
      CUDA_VISIBLE_DEVICES: "-1"
      JULIA_DEBUG: "Documenter"
    plugins:
      - JuliaCI/julia#v1:
          version: "1.8"
    command: |
      - "julia --color=yes --project=docs/ docs/make.jl"
    agents:
      queue: Oceananigans
      architecture: CPU
    depends_on: "init_cpu"
    if: !build.pull_request.draft
